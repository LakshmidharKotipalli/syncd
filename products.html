<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sync’d | Shop Jewelry</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="icon" href="assets/images/luxury_jewelry_logo_1767966924039.png" type="image/png">
  <script src="assets/products.js"></script>
</head>

<body>
  <nav class="navbar scrolled" id="navbar">
    <div class="nav-links">
      <a href="products.html?category=necklace">Necklaces</a>
      <a href="products.html?category=earrings">Earrings</a>
      <a href="products.html?category=bracelet">Bracelets</a>
    </div>
    <a href="index.html" class="nav-logo">
      <img src="assets/images/syncd_logo_new.png" alt="sync’d logo" />
    </a>
    <div class="nav-actions">
      <div class="account-wrapper">
        <button class="icon-btn" id="accountBtn">Profile</button>
        <div class="account-dropdown" id="accountMenu">
          <a href="profile.html">My Profile</a>
          <a href="orders.html">My Orders</a>
          <a href="#">Logout</a>
        </div>
      </div>
      <button class="icon-btn cart-btn" id="cartBtn">
        Cart <span class="cart-count" id="cartCount">0</span>
      </button>
    </div>
  </nav>

  <div class="cart-drawer" id="cartDrawer">
    <div class="cart-header">
      <h3>Collection</h3><button id="closeCart">✕</button>
    </div>
    <div class="cart-items" id="cartItems"></div>
    <div class="cart-footer">
      <div class="cart-total"><span>Total</span><span>$<span id="cartTotal">0</span></span></div>
      <a href="checkout.html" class="btn-primary">Checkout</a>
    </div>
  </div>
  <div class="cart-overlay" id="cartOverlay"></div>

  <!-- VTO MODAL -->
  <div class="vto-modal" id="vtoModal">
    <div class="vto-container">
      <div class="vto-header">
        <h3>Virtual Mirror</h3>
        <button class="vto-close" id="closeVTO">✕</button>
      </div>
      <div class="vto-viewport">
        <video id="vtoVideo" autoplay playsinline muted></video>
        <img id="vtoOverlay" class="vto-overlay-item" src="" alt="Jewelry Overlay" />
      </div>
      <div class="vto-controls">
        <div class="control-group">
          <label>Scale</label>
          <input type="range" class="vto-slider" id="vtoScale" min="50" max="400" value="150" />
        </div>
        <div class="control-group">
          <label>Rotate</label>
          <input type="range" class="vto-slider" id="vtoRotate" min="-180" max="180" value="0" />
        </div>
        <div class="control-group" style="justify-content: center; align-items: flex-start;">
          <p style="font-size: 11px; color: var(--primary-light);">Drag the item to position it perfectly</p>
        </div>
      </div>
    </div>
  </div>

  <main style="padding-top: 150px;">
    <section class="featured">
      <div class="section-header"><span id="category-path">Collection</span>
        <h2 id="category-title">All Products</h2>
      </div>
      <div class="product-grid" id="productGrid"></div>
    </section>
  </main>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('category') || 'necklace';
    document.getElementById('category-title').textContent = category.charAt(0).toUpperCase() + category.slice(1) + 's';

    const container = document.getElementById('productGrid');
    const products = productData[category] || productData.necklace;

    products.forEach(p => {
      container.innerHTML += `
        <div class="product-card">
          <div class="product-image"><img src="${p.image}" alt="${p.name}" /><div class="product-badge">${p.badge}</div></div>
          <div class="product-details">
            <h4>${p.name}</h4><p style="font-size: 11px; margin-bottom: 12px; height: 32px; overflow: hidden;">${p.description}</p><p class="price">$${p.price.toLocaleString()}</p>
            <div class="product-actions">
              <div class="qty-control"><button onclick="chQty(this, -1)">−</button><span class="qty">1</span><button onclick="chQty(this, 1)">+</button></div>
              <button class="add-btn" onclick="hAddToCart('${p.id}', this)">+</button>
            </div>
            <button class="vto-btn" onclick="openVTO('${p.id}')">Try On Virtually</button>
          </div>
        </div>`;
    });

    function chQty(btn, ch) { let s = btn.parentElement.querySelector('.qty'); let v = parseInt(s.textContent) + ch; if (v < 1) v = 1; s.textContent = v; }
    function hAddToCart(id, btn) {
      const p = products.find(x => x.id === id); const q = parseInt(btn.parentElement.querySelector('.qty').textContent);
      Cart.add(p, q); btn.innerHTML = "✓"; setTimeout(() => btn.innerHTML = "+", 1000);
    }
    function renderCart() {
      const c = Cart.get(); const items = document.getElementById("cartItems");
      items.innerHTML = "";
      c.forEach((item, i) => {
        items.innerHTML += `
          <div class="cart-item">
            <div class="cart-item-img" style="background-image: url('${item.image}'); background-size: cover;"></div>
            <div class="cart-item-info">
              <h5>${item.name}</h5><p>$${item.price.toLocaleString()}</p>
              <div class="qty-control"><button onclick="Cart.updateQty(${i}, -1)">−</button><span>${item.quantity}</span><button onclick="Cart.updateQty(${i}, 1)">+</button></div>
            </div>
          </div>`;
      });
      document.getElementById("cartTotal").textContent = Cart.getTotal().toLocaleString();
      document.getElementById("cartCount").textContent = Cart.getCount();
    }
    window.addEventListener('cartUpdated', renderCart);

    // VTO LOGIC
    const vtoModal = document.getElementById('vtoModal');
    const vtoVideo = document.getElementById('vtoVideo');
    const vtoOverlay = document.getElementById('vtoOverlay');
    const vtoScale = document.getElementById('vtoScale');
    const vtoRotate = document.getElementById('vtoRotate');
    const closeVTO = document.getElementById('closeVTO');

    let isDragging = false;
    let startX, startY;
    let posX = 0, posY = 0;

    function openVTO(id) {
      const p = products.find(x => x.id === id);

      if (!p || !p.vtoImage) {
        alert("Virtual try-on is not available for this item (Bracelets coming soon).");
        return;
      }

      vtoOverlay.src = p.vtoImage;
      vtoModal.classList.add('show');

      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
        .then(stream => {
          vtoVideo.srcObject = stream;
        })
        .catch(err => {
          alert("Camera access denied or not available.");
          vtoModal.classList.remove('show');
        });
    }

    closeVTO.onclick = () => {
      vtoModal.classList.remove('show');
      if (vtoVideo.srcObject) {
        vtoVideo.srcObject.getTracks().forEach(track => track.stop());
      }
    };

    function updateTransform() {
      vtoOverlay.style.width = vtoScale.value + 'px';
      vtoOverlay.style.transform = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) rotate(${vtoRotate.value}deg)`;
    }

    vtoScale.oninput = updateTransform;
    vtoRotate.oninput = updateTransform;

    vtoOverlay.addEventListener('mousedown', startDrag);
    vtoOverlay.addEventListener('touchstart', startDrag);
    window.addEventListener('mousemove', drag);
    window.addEventListener('touchmove', drag);
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);

    function startDrag(e) {
      isDragging = true;
      const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
      startX = clientX - posX;
      startY = clientY - posY;
      e.preventDefault();
    }

    function drag(e) {
      if (!isDragging) return;
      const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
      posX = clientX - startX;
      posY = clientY - startY;
      updateTransform();
    }

    function endDrag() {
      isDragging = false;
    }

    const cartBtn = document.getElementById("cartBtn");
    const cartDrawer = document.getElementById("cartDrawer");
    const cartOverlay = document.getElementById("cartOverlay");
    const closeCart = document.getElementById("closeCart");
    cartBtn.onclick = () => { cartDrawer.classList.add("open"); cartOverlay.classList.add("show"); renderCart(); };
    closeCart.onclick = closeCartDrawer;
    cartOverlay.onclick = closeCartDrawer;
    function closeCartDrawer() { cartDrawer.classList.remove("open"); cartOverlay.classList.remove("show"); }

    const accountBtn = document.getElementById("accountBtn");
    const accountMenu = document.getElementById("accountMenu");
    accountBtn.onclick = () => accountMenu.classList.toggle("show");

    renderCart();
  </script>
</body>

</html>